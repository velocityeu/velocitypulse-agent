<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VelocityPulse Agent</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-primary: #030712;
            --bg-secondary: #0f172a;
            --bg-card: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent: #3b82f6;
            --accent-light: #60a5fa;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #334155;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header h1 {
            font-size: 1.25rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header h1 .brand-text { color: var(--accent); font-weight: 700; }
        .header h1 .agent-text { color: var(--text-secondary); font-weight: 400; }

        .header .logo { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; }
        .header .logo svg { width: 36px; height: 36px; }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .version-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.25rem 0.625rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            font-family: monospace;
        }
        .version-badge.current { background: rgba(59, 130, 246, 0.2); color: var(--accent-light); }
        .version-badge.update { background: rgba(245, 158, 11, 0.2); color: var(--warning); cursor: pointer; }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.connected { background: var(--success); }
        .status-dot.disconnected { background: var(--danger); }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes sonar-ripple {
            0% { transform: scale(1); opacity: 0.7; }
            100% { transform: scale(2.5); opacity: 0; }
        }

        .sonar-btn {
            position: relative;
            background: none;
            border: 2px solid var(--accent);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent);
            transition: all 0.2s;
        }
        .sonar-btn:hover { background: rgba(59, 130, 246, 0.15); }
        .sonar-btn.pinging::after {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 50%;
            border: 2px solid var(--accent);
            animation: sonar-ripple 1s ease-out infinite;
        }

        .main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .grid { display: grid; gap: 1.5rem; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }

        .card {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .card-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-header h2 { font-size: 1rem; font-weight: 600; }
        .card-body { padding: 1.25rem; }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .stat-value { font-size: 1.5rem; font-weight: bold; }
        .stat-value.online { color: var(--success); }
        .stat-value.offline { color: var(--danger); }
        .stat-value.degraded { color: var(--warning); }
        .stat-value.accent { color: var(--accent); }
        .stat-value.muted { color: var(--text-secondary); }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 0.25rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary { background: var(--accent); color: var(--bg-primary); }
        .btn-primary:hover { opacity: 0.9; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--bg-card); }

        .segment-list, .device-list, .log-list { list-style: none; }

        .segment-item, .device-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .segment-item:last-child, .device-item:last-child { border-bottom: none; }
        .segment-info, .device-info { flex: 1; }
        .segment-name, .device-name { font-weight: 500; }
        .segment-cidr, .device-ip { font-size: 0.75rem; color: var(--text-secondary); font-family: monospace; }
        .device-meta { font-size: 0.6875rem; color: var(--text-secondary); margin-top: 0.125rem; }

        .segment-stats, .device-stats {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.875rem;
        }

        .badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-success { background: rgba(0, 255, 136, 0.2); color: var(--success); }
        .badge-warning { background: rgba(255, 170, 0, 0.2); color: var(--warning); }
        .badge-danger { background: rgba(255, 68, 68, 0.2); color: var(--danger); }
        .badge-secondary { background: var(--bg-secondary); color: var(--text-secondary); }
        .badge-accent { background: rgba(59, 130, 246, 0.2); color: var(--accent-light); }

        /* Progress bar for scanning segments */
        .scan-progress {
            height: 3px;
            background: var(--border);
            border-radius: 2px;
            margin-top: 0.375rem;
            overflow: hidden;
        }
        .scan-progress-bar {
            height: 100%;
            background: var(--accent);
            border-radius: 2px;
            animation: scan-indeterminate 1.5s ease-in-out infinite;
        }
        @keyframes scan-indeterminate {
            0% { width: 0%; margin-left: 0%; }
            50% { width: 40%; margin-left: 30%; }
            100% { width: 0%; margin-left: 100%; }
        }

        .log-item {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.8125rem;
            display: flex;
            gap: 0.75rem;
        }

        .log-item:last-child { border-bottom: none; }

        .log-time {
            color: var(--text-secondary);
            font-family: monospace;
            font-size: 0.75rem;
            white-space: nowrap;
        }

        .log-level {
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.625rem;
            padding: 0.125rem 0.375rem;
            border-radius: 3px;
        }

        .log-level.info { background: rgba(0, 212, 255, 0.2); color: var(--accent); }
        .log-level.warn { background: rgba(255, 170, 0, 0.2); color: var(--warning); }
        .log-level.error { background: rgba(255, 68, 68, 0.2); color: var(--danger); }
        .log-level.debug { background: var(--bg-secondary); color: var(--text-secondary); }

        .log-message { flex: 1; word-break: break-word; }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .scrollable { max-height: 300px; overflow-y: auto; }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
        }

        .info-row:last-child { border-bottom: none; }
        .info-label { color: var(--text-secondary); }
        .info-value { font-family: monospace; }

        /* Health bar */
        .health-bar-container {
            background: var(--bg-primary);
            border-radius: 4px;
            height: 6px;
            overflow: hidden;
            margin-top: 0.25rem;
        }
        .health-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        .health-bar.good { background: var(--success); }
        .health-bar.warn { background: var(--warning); }
        .health-bar.critical { background: var(--danger); }

        .footer {
            margin-top: 2rem;
            padding: 1rem 2rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .footer a { color: var(--accent); text-decoration: none; }
        .footer a:hover { text-decoration: underline; }

        @media (max-width: 768px) {
            .stat-grid { grid-template-columns: repeat(3, 1fr); }
            .header { padding: 1rem; }
            .main { padding: 1rem; }
            .footer { flex-direction: column; gap: 0.5rem; text-align: center; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <h1>
                <span class="logo">
                    <svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect width="40" height="40" rx="8" fill="url(#logo-gradient)"/>
                        <path d="M10 12H22V16H10V12Z" fill="white"/>
                        <path d="M26 16H22V8" stroke="white" stroke-width="4" stroke-linecap="square"/>
                        <circle cx="20" cy="26" r="6" stroke="white" stroke-width="3" fill="none"/>
                        <circle cx="20" cy="26" r="2" fill="white"/>
                        <defs>
                            <linearGradient id="logo-gradient" x1="0" y1="0" x2="40" y2="40" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#3b82f6"/>
                                <stop offset="1" stop-color="#60a5fa"/>
                            </linearGradient>
                        </defs>
                    </svg>
                </span>
                <span><span class="brand-text">VelocityPulse</span> <span class="agent-text">Agent</span></span>
            </h1>
            <span class="version-badge current" id="version-badge">v1.0.0</span>
            <span class="version-badge current" id="build-badge" style="font-size: 0.65rem; opacity: 0.7;"></span>
        </div>
        <div class="header-right">
            <button class="sonar-btn" id="sonar-btn" onclick="pingDashboard()" title="Sonar Ping">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.14 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"/>
                </svg>
            </button>
            <div class="connection-status">
                <span class="status-dot" id="connection-dot"></span>
                <span id="connection-text">Connecting...</span>
            </div>
        </div>
    </header>

    <main class="main">
        <!-- Stats Overview -->
        <div class="stat-grid">
            <div class="stat-card">
                <div class="stat-value accent" id="stat-segments">0</div>
                <div class="stat-label">Segments</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-devices">0</div>
                <div class="stat-label">Devices</div>
            </div>
            <div class="stat-card">
                <div class="stat-value online" id="stat-online">0</div>
                <div class="stat-label">Online</div>
            </div>
            <div class="stat-card">
                <div class="stat-value offline" id="stat-offline">0</div>
                <div class="stat-label">Offline</div>
            </div>
            <div class="stat-card">
                <div class="stat-value muted" id="stat-uptime">0s</div>
                <div class="stat-label">Uptime</div>
            </div>
            <div class="stat-card">
                <div class="stat-value muted" id="stat-memory">0 MB</div>
                <div class="stat-label">Memory</div>
            </div>
        </div>

        <div class="grid grid-2">
            <!-- Agent Info -->
            <div class="card">
                <div class="card-header">
                    <h2>Agent Information</h2>
                </div>
                <div class="card-body">
                    <div class="info-row">
                        <span class="info-label">Agent Name</span>
                        <span class="info-value" id="agent-name">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Agent ID</span>
                        <span class="info-value" id="agent-id">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Organization</span>
                        <span class="info-value" id="org-id">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Version</span>
                        <span class="info-value" id="version">1.0.0</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Last Heartbeat</span>
                        <span class="info-value" id="last-heartbeat">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Started</span>
                        <span class="info-value" id="started-at">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Dashboard</span>
                        <span class="info-value"><a href="#" id="dashboard-link" target="_blank" style="color: var(--accent)">-</a></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Memory</span>
                        <span class="info-value" id="memory-detail">-</span>
                    </div>
                    <div id="memory-bar-row" class="info-row" style="display:block; padding-top:0; border:none;">
                        <div class="health-bar-container">
                            <div class="health-bar good" id="memory-bar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Configuration -->
            <div class="card">
                <div class="card-header">
                    <h2>Configuration</h2>
                </div>
                <div class="card-body">
                    <div class="info-row">
                        <span class="info-label">Dashboard URL</span>
                        <span class="info-value" id="config-dashboard-url">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Ping Timeout</span>
                        <span class="info-value" id="config-ping-timeout">2000ms</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Discovery Methods</span>
                        <span class="info-value" id="config-discovery">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Enabled Segments</span>
                        <span class="info-value" id="config-segments">-</span>
                    </div>
                    <div id="config-intervals"></div>
                </div>
            </div>
        </div>

        <div class="grid grid-2" style="margin-top: 1.5rem;">
            <!-- Actions -->
            <div class="card">
                <div class="card-header">
                    <h2>Actions</h2>
                </div>
                <div class="card-body">
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn btn-primary" id="btn-scan" onclick="triggerScan()">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                            Scan Now
                        </button>
                        <button class="btn btn-secondary" onclick="pingDashboard()">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.14 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"/>
                            </svg>
                            Ping Dashboard
                        </button>
                    </div>
                    <p style="margin-top: 1rem; font-size: 0.875rem; color: var(--text-secondary);">
                        Trigger a manual network scan or test connectivity to the dashboard.
                    </p>
                </div>
            </div>
        </div>

        <div class="grid grid-2" style="margin-top: 1.5rem;">
            <!-- Network Segments -->
            <div class="card">
                <div class="card-header">
                    <h2>Network Segments</h2>
                    <span class="badge badge-secondary" id="segment-count">0</span>
                </div>
                <div class="card-body" style="padding: 0;">
                    <ul class="segment-list scrollable" id="segment-list">
                        <li class="empty-state">No segments assigned</li>
                    </ul>
                </div>
            </div>

            <!-- Recent Logs -->
            <div class="card">
                <div class="card-header">
                    <h2>Activity Log</h2>
                    <button class="btn btn-secondary" onclick="clearLogs()" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Clear</button>
                </div>
                <div class="card-body" style="padding: 0;">
                    <ul class="log-list scrollable" id="log-list">
                        <li class="empty-state">No recent activity</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Devices -->
        <div class="card" style="margin-top: 1.5rem;">
            <div class="card-header">
                <h2>Discovered Devices</h2>
                <span class="badge badge-secondary" id="device-count">0</span>
            </div>
            <div class="card-body" style="padding: 0;">
                <ul class="device-list scrollable" id="device-list" style="max-height: 400px;">
                    <li class="empty-state">No devices discovered yet</li>
                </ul>
            </div>
        </div>

        <footer class="footer">
            <span>VelocityPulse Agent v<span id="footer-version">1.0.0</span> <span id="footer-build" style="opacity: 0.6;"></span></span>
            <span>
                <a href="https://velocitypulse.io" target="_blank">velocitypulse.io</a>
                &middot;
                Real-time IT Infrastructure Monitoring
            </span>
        </footer>
    </main>

    <script>
        const socket = io();
        let state = {
            connected: false,
            segments: [],
            devices: [],
            logs: [],
            health: null,
            versionInfo: null,
            config: null,
        };

        // Sonar ping audio
        let sonarAudio = null;
        try { sonarAudio = new Audio('/sounds/sonar-ping.mp3'); sonarAudio.volume = 0.3; } catch(e) {}

        // Socket event handlers
        socket.on('connect', () => { console.log('Socket connected'); });

        socket.on('state', (newState) => {
            state = { ...state, ...newState };
            updateUI();
        });

        socket.on('connection', (data) => {
            state.connected = data.connected;
            state.agentId = data.agentId;
            state.organizationId = data.organizationId;
            state.lastHeartbeat = data.lastHeartbeat;
            updateConnectionStatus();
            updateAgentInfo();
        });

        socket.on('segments', (segments) => {
            state.segments = segments;
            updateSegments();
            updateStats();
        });

        socket.on('devices', (devices) => {
            state.devices = devices;
            updateDevices();
            updateStats();
        });

        socket.on('device_status', (data) => {
            const device = state.devices.find(d => d.id === data.id);
            if (device) {
                device.status = data.status;
                device.responseTime = data.responseTime;
                updateDevices();
                updateStats();
            }
        });

        socket.on('log', (entry) => {
            state.logs.unshift(entry);
            if (state.logs.length > 100) state.logs = state.logs.slice(0, 100);
            updateLogs();
        });

        socket.on('scanning', (scanning) => {
            const btn = document.getElementById('btn-scan');
            btn.disabled = scanning;
            btn.innerHTML = scanning
                ? '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 12a8 8 0 0116 0"/></svg> Scanning...'
                : '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg> Scan Now';
        });

        socket.on('health', (health) => {
            state.health = health;
            updateHealth();
        });

        socket.on('version_info', (info) => {
            state.versionInfo = info;
            updateVersionBadge();
        });

        socket.on('config_update', (config) => {
            state.config = config;
            updateConfig();
        });

        // Update functions
        function updateUI() {
            updateConnectionStatus();
            updateAgentInfo();
            updateStats();
            updateSegments();
            updateDevices();
            updateLogs();
            updateHealth();
            updateVersionBadge();
            updateConfig();
        }

        function updateConnectionStatus() {
            const dot = document.getElementById('connection-dot');
            const text = document.getElementById('connection-text');
            if (state.connected) {
                dot.className = 'status-dot connected';
                text.textContent = 'Connected to Dashboard';
            } else {
                dot.className = 'status-dot disconnected';
                text.textContent = 'Disconnected';
            }
        }

        function updateAgentInfo() {
            document.getElementById('agent-name').textContent = state.agentName || '-';
            document.getElementById('agent-id').textContent = state.agentId ? state.agentId.substring(0, 8) + '...' : '-';
            document.getElementById('org-id').textContent = state.organizationId ? state.organizationId.substring(0, 8) + '...' : '-';
            document.getElementById('version').textContent = state.version || '1.0.0';
            document.getElementById('footer-version').textContent = state.version || '1.0.0';
            const bid = state.buildId && state.buildId !== '__BUILD_ID__' ? state.buildId : '';
            document.getElementById('build-badge').textContent = bid ? '(' + bid + ')' : '';
            document.getElementById('footer-build').textContent = bid ? '(' + bid + ')' : '';
            document.getElementById('last-heartbeat').textContent = state.lastHeartbeat
                ? new Date(state.lastHeartbeat).toLocaleTimeString()
                : '-';

            if (state.health && state.health.startedAt) {
                document.getElementById('started-at').textContent = new Date(state.health.startedAt).toLocaleString();
            }

            const link = document.getElementById('dashboard-link');
            if (state.dashboardUrl) {
                link.href = state.dashboardUrl;
                link.textContent = state.dashboardUrl.replace(/^https?:\/\//, '');
            }
        }

        function updateStats() {
            document.getElementById('stat-segments').textContent = state.segments.length;
            document.getElementById('stat-devices').textContent = state.devices.length;
            const online = state.devices.filter(d => d.status === 'online').length;
            const offline = state.devices.filter(d => d.status === 'offline').length;
            document.getElementById('stat-online').textContent = online;
            document.getElementById('stat-offline').textContent = offline;
        }

        function updateHealth() {
            if (!state.health) return;
            const h = state.health;

            // Uptime
            document.getElementById('stat-uptime').textContent = formatUptime(h.uptime);

            // Memory
            document.getElementById('stat-memory').textContent = h.memoryUsedMB + ' MB';
            document.getElementById('memory-detail').textContent = h.memoryUsedMB + ' / ' + h.memoryTotalMB + ' MB';

            const memPct = Math.round((h.memoryUsedMB / h.memoryTotalMB) * 100);
            const bar = document.getElementById('memory-bar');
            bar.style.width = memPct + '%';
            bar.className = 'health-bar ' + (memPct > 85 ? 'critical' : memPct > 60 ? 'warn' : 'good');
        }

        function updateVersionBadge() {
            const badge = document.getElementById('version-badge');
            if (state.versionInfo && state.versionInfo.updateAvailable) {
                badge.className = 'version-badge update';
                badge.textContent = 'v' + state.versionInfo.current + ' \u2192 v' + state.versionInfo.latest;
                badge.title = 'Update available! Click to learn more.';
            } else {
                badge.className = 'version-badge current';
                const bid = state.buildId && state.buildId !== '__BUILD_ID__' ? state.buildId : '';
                badge.textContent = 'v' + (state.version || '1.0.0') + (bid ? ' (' + bid + ')' : '');
                badge.title = 'Up to date';
            }
        }

        function updateConfig() {
            const cfg = state.config;
            if (!cfg) return;

            const dashUrl = document.getElementById('config-dashboard-url');
            dashUrl.textContent = state.dashboardUrl || '-';

            document.getElementById('config-ping-timeout').textContent = cfg.pingTimeoutMs + 'ms';

            const methods = cfg.discoveryMethods || [];
            document.getElementById('config-discovery').textContent =
                methods.length > 0 ? methods.join(', ') : 'None';

            const segments = cfg.enabledSegments || [];
            document.getElementById('config-segments').textContent =
                segments.length > 0 ? segments.length + ' segment' + (segments.length !== 1 ? 's' : '') : 'All';

            // Scan intervals per segment
            const intervalsEl = document.getElementById('config-intervals');
            const intervals = cfg.scanIntervals || {};
            const keys = Object.keys(intervals);
            if (keys.length > 0) {
                intervalsEl.innerHTML = keys.map(segId => {
                    const seg = state.segments.find(s => s.id === segId);
                    const name = seg ? escapeHtml(seg.name) : segId.substring(0, 8) + '...';
                    const secs = intervals[segId];
                    const display = secs >= 3600 ? Math.floor(secs / 3600) + 'h'
                        : secs >= 60 ? Math.floor(secs / 60) + 'm'
                        : secs + 's';
                    return '<div class="info-row"><span class="info-label">' + name + '</span><span class="info-value">every ' + display + '</span></div>';
                }).join('');
            } else {
                intervalsEl.innerHTML = '';
            }
        }

        function formatUptime(seconds) {
            if (seconds < 60) return Math.floor(seconds) + 's';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ' + Math.floor((seconds % 3600) / 60) + 'm';
            return Math.floor(seconds / 86400) + 'd ' + Math.floor((seconds % 86400) / 3600) + 'h';
        }

        function updateSegments() {
            const list = document.getElementById('segment-list');
            document.getElementById('segment-count').textContent = state.segments.length;

            if (state.segments.length === 0) {
                list.innerHTML = '<li class="empty-state">No segments assigned</li>';
                return;
            }

            list.innerHTML = state.segments.map(seg => `
                <li class="segment-item">
                    <div class="segment-info">
                        <div class="segment-name">${escapeHtml(seg.name)}</div>
                        <div class="segment-cidr">${escapeHtml(seg.cidr)}</div>
                        ${seg.scanning ? '<div class="scan-progress"><div class="scan-progress-bar"></div></div>' : ''}
                    </div>
                    <div class="segment-stats">
                        <span class="badge ${seg.scanning ? 'badge-warning' : 'badge-secondary'}">
                            ${seg.scanning ? 'Scanning...' : (seg.deviceCount || 0) + ' devices'}
                        </span>
                    </div>
                </li>
            `).join('');
        }

        function updateDevices() {
            const list = document.getElementById('device-list');
            document.getElementById('device-count').textContent = state.devices.length;

            if (state.devices.length === 0) {
                list.innerHTML = '<li class="empty-state">No devices discovered yet</li>';
                return;
            }

            const sorted = [...state.devices].sort((a, b) => {
                const statusOrder = { online: 0, degraded: 1, unknown: 2, offline: 3 };
                return (statusOrder[a.status] || 2) - (statusOrder[b.status] || 2);
            });

            list.innerHTML = sorted.map(dev => `
                <li class="device-item">
                    <div class="device-info">
                        <div class="device-name">${escapeHtml(dev.name)}</div>
                        <div class="device-ip">${escapeHtml(dev.ip)}${dev.mac ? ' &middot; ' + escapeHtml(dev.mac) : ''}</div>
                    </div>
                    <div class="device-stats">
                        ${dev.responseTime ? `<span style="font-size: 0.75rem; color: var(--text-secondary)">${dev.responseTime}ms</span>` : ''}
                        <span class="badge badge-${getStatusBadge(dev.status)}">${dev.status}</span>
                    </div>
                </li>
            `).join('');
        }

        function updateLogs() {
            const list = document.getElementById('log-list');

            if (state.logs.length === 0) {
                list.innerHTML = '<li class="empty-state">No recent activity</li>';
                return;
            }

            list.innerHTML = state.logs.slice(0, 50).map(log => `
                <li class="log-item">
                    <span class="log-time">${new Date(log.timestamp).toLocaleTimeString()}</span>
                    <span class="log-level ${log.level}">${log.level}</span>
                    <span class="log-message">${escapeHtml(log.message)}</span>
                </li>
            `).join('');
        }

        // Actions
        function triggerScan() {
            socket.emit('command', { type: 'scan_now' });
        }

        function pingDashboard() {
            socket.emit('command', { type: 'ping' });
            // Play sonar sound + animate button
            if (sonarAudio) {
                sonarAudio.currentTime = 0;
                sonarAudio.play().catch(() => {});
            }
            const btn = document.getElementById('sonar-btn');
            btn.classList.add('pinging');
            setTimeout(() => btn.classList.remove('pinging'), 2000);
        }

        function clearLogs() {
            state.logs = [];
            updateLogs();
        }

        // Helpers
        function escapeHtml(str) {
            if (!str) return '';
            return str.toString()
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;');
        }

        function getStatusBadge(status) {
            switch (status) {
                case 'online': return 'success';
                case 'offline': return 'danger';
                case 'degraded': return 'warning';
                default: return 'secondary';
            }
        }

        // Initial UI update
        updateUI();
    </script>
</body>
</html>
